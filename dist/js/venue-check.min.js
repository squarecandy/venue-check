function waitForElementToDisplay(e,n,c,t){const s=Date.now();!function o(){null!==document.querySelector(e)?n():setTimeout((function(){t&&Date.now()-s>t||o()}),c)}()}jQuery((function(e){function n(n,t){e("#venuecheck-progress .progress-bar span").css({width:"0%"}),e(".venuecheck-progress-percent-done").text("0%"),e("#venuecheck-messages-container, #venuecheck-progress").show();const s=e("#post_ID").val(),o=[];for(let e=0;e<n.length;e+=t)venuecheck.debug&&console.log("venuecheck_check_venues i: "+e),o.push(n.slice(e,e+t));let i=[];return o.reduce((function(a,r){const u=n.length,l=o.indexOf(r);return a.then((function(){return venuecheck.debug&&console.log("nonce: "+venuecheck.nonce),e.ajax({type:"POST",dataType:"json",url:venuecheck.ajax_url,data:{action:"venuecheck_check_venues",nonce:venuecheck.nonce,event_recurrences:r,postID:s,total_count:u,batch_size:t,batch_count:l},beforeSend(){const n=Math.max(0,(l+1)*t-u),s=Math.round(l*t/u*100),i=Math.round(((l+1)*t-n)/u*100);o.length>1&&function n(t,s){clearTimeout(c),venuecheck.debug&&console.log("check_venues_progress percent: "+t);if(e("#venuecheck-progress .progress-bar span").css({width:t+"%"}),e(".venuecheck-progress-percent-done").text(t+"%"),(t+=Math.floor(5*Math.random()+1))<=s){const e=Math.floor(1500*Math.random()+300);c=setTimeout((function(){n(t,s)}),e)}else 100===s&&(e("#venuecheck-progress .progress-bar span").css({width:"100%"}),e(".venuecheck-progress-percent-done").text("100%"))}(s,i),e("#saved_tribe_venue").prop("readonly",!0).addClass("readonly")}}).then((function(e){i=i.concat(e)}))}))}),Promise.resolve()).then((function(){const n=Object.values(i.reduce((function(e,n){return e[n.venueTitle]?e[n.venueTitle].events=e[n.venueTitle].events.concat(n.events):e[n.venueTitle]=n,e}),{}));venuecheck.debug&&console.log("CONFLICTS",i),i=n,venuecheck.debug&&console.log("CONFLCTS MERGED",i),clearTimeout(c),e("#venuecheck-progress .progress-bar span").css({width:"100%"}),e(".venuecheck-progress-percent-done").text("100%"),setTimeout((function(){!function(n){e("body").addClass("venuecheck-update"),venuecheck.debug&&console.log("starting venuecheck_check_venues_handler");const c=e("#saved_tribe_venue").find("option, optgroup"),t=[{}];venuecheck.debug&&console.log("venuecheck_venues",c);c.each((function(){"My Venues"!==e(this).attr("label")&&"My Venues"!==e(this).parent().attr("label")||e(this).remove(),"Available Venues"===e(this).attr("label")&&(e(this).parent().append(e(this).html()),e(this).remove())}));let s="",o="";if(void 0!==n&&0!==n.length){let c=Object.keys(n).length;c+=1===c?" unavailable venue.":" unavailable venues.",s+='<div id="venuecheck-conflicts-report-count" class="notice notice-info">'+c,s+='&nbsp;<a id="venuecheck-conflicts-report-link">Show Details</a></div>',o+='<div id="venuecheck-conflicts-report-container">',o+='<div id="venuecheck-report-links">',o+='<a id="venuecheck-report-conflicts-link">Recheck for Venue Conflicts</a>',o+='<span class="venuecheck-divider">&nbsp;|&nbsp;</span>',o+='<a id="venuecheck-conflicts-report-close">Close</a>',o+="</div>",o+='<table id="venuecheck-conflicts-report-table">',venuecheck.debug&&console.log("venuecheck_conflicts",n,e.type(n)),venuecheck.debug&&console.log("venuecheck_venue_options",t),e("#saved_tribe_venue option").removeAttr("disabled"),e.each(n,(function(n,c){venuecheck.debug&&console.log(n,c.venueID,c),e('#saved_tribe_venue option[value="'+c.venueID+'"]').attr("disabled","disabled").removeAttr("selected"),o+='<thead class="venuecheck-conflicts-report-venue-title"><tr><td colspan="2">'+c.venueTitle+"</td></tr></thead>",o+='<thead class="venuecheck-conflicts-report-venue-heading"><tr><td>Date</td><td>Event</td></tr></thead><tbody>',e.each(c.events,(function(e,n){o+='<tr><td class="venuecheck-conflicts-report-venue-date">'+n.eventDate+'</td><td class="venuecheck-conflicts-report-venue-event"><a href="'+n.eventLink+'" target="_blank" class="venuecheck-report-link"><span>'+n.eventTitle+'</span><i class="fas fa-external-link-alt" aria-hidden="true"></i></a></td></tr>'}))})),e("#saved_tribe_venue").select2(),o+="</tbody></table></div>"}else 0===n.length&&(s+='<div id="venuecheck-conflicts-report-count" class="notice notice-info">All venues are available.</div>',o+="",e("#saved_tribe_venue option").removeAttr("disabled"),e("#saved_tribe_venue").select2());e("#venuecheck-messages").append(s),e("#venuecheck-conflicts-report").append(o).show(),e("#venuecheck-conflicts-report-link, #venuecheck-conflicts-report-close").on("click",(function(){e("#venuecheck-report-container").slideToggle("fast"),e("#venuecheck-conflicts-report-link").html("Show Details"===e("#venuecheck-conflicts-report-link").text()?"Hide Details":"Show Details")})),e("#venuecheck-venue-select").show(),e("#venuecheck-processing, #venuecheck-progress").hide(),e("#venuecheck-conflicts-link").removeClass("venuecheck-disabled"),e("#publish").prop("disabled",!1),e("#saved_tribe_venue").prop("readonly",!1).removeClass("readonly"),e("#venuecheck-change-venue").hide(),e("body").addClass("venuecheck-venues"),a()}(i)}),500)}))}let c;function t(e){if(!e)return"00:00:00";let n=0;const c=e.match(/^(\d+)/);c&&1 in c&&(n=Number(c[1]));let t=0;const s=e.match(/:(\d+)/);s&&1 in s&&(t=Number(s[1]));const o=e.substr(-2).toLowerCase();"pm"===o&&n<12&&(n+=12),"am"===o&&12===n&&(n-=12);let i=n.toString(),a=t.toString();return n<10&&(i="0"+i),t<10&&(a="0"+a),i+":"+a+":00"}function s(){!0===e("#allDayCheckbox").prop("checked")?(e("#venuecheck-offsets").hide(),e("#_venuecheck_event_offset_start").val("0"),e("#_venuecheck_event_offset_end").val("0")):e("#venuecheck-offsets").show()}function o(){e("#venuecheck-messages-container, #venuecheck-modified-publish, #venuecheck-modified").show(),e("#venuecheck-report-container, #venuecheck-conflicts-report-count, #venuecheck-progress").hide(),e("#publish").prop("disabled",!0),e("#saved_tribe_venue").prop("readonly",!0).addClass("readonly"),e("#venuecheck-change-venue").show()}function i(){e("#venuecheck-messages-container").removeClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-wait").hide()}function a(){e("#saved_tribe_venue:not(.venuecheck-preserve-disabled)").prop("readonly",!1).removeClass("readonly"),e(".tribe-datetime-block :input:not(.venuecheck-preserve-disabled)").prop("disabled",!1),e("#saved_tribe_venue, .tribe-datetime-block :input").removeClass("venuecheck-preserve-disabled"),e("#publish").prop("disabled",!1),e("#tribe_events_event_details a").removeClass("venuecheck-disabled")}function r(){""===e("#saved_tribe_venue").val()?e("#venuecheck-change-venue .venuecheck-divider").hide():e("#venuecheck-change-venue .venuecheck-divider").show()}window.addEventListener("load",n=>{venuecheck.debug&&console.log("load event fire",n);const c=window.location.href;/post-new.php/.test(c)&&e("body").addClass("venuecheck-new"),/post.php/.test(c)&&e("body").addClass("venuecheck-update"),setTimeout((function(){const n=e("form#post"),c=n.serialize();venuecheck.debug&&(console.log("check form change status after 3 seconds"),console.log("is origForm same as current state?",n.serialize()===c)),e(document).on("change","body.venuecheck-update #EventInfo :input,body.venuecheck-update #EventInfo .tribe-dropdown,body.venuecheck-update #EventInfo .tribe-button-field",(function(){n.serialize()!==c?o():(e("#venuecheck-messages-container, #venuecheck-modified-publish, #venuecheck-modified").not(".active").hide(),e("#venuecheck-messages-container.has-messages, #venuecheck-conflicts-report-count").show(),e("#publish").prop("disabled",!1),e("body").hasClass("venuecheck-venues")&&(e("#venuecheck-messages-container").show(),e("#venuecheck-report-container").hide(),e("#venuecheck-conflicts-report-link").text("Show Details"),e("#saved_tribe_venue").prop("readonly",!1).removeClass("readonly")))})),e(document).on("click","body.venuecheck-update .tribe-row-delete-dialog .ui-dialog-buttonpane .ui-dialog-buttonset .button-red",(function(){o()}))}),3e3)}),waitForElementToDisplay("#saved_tribe_venue",(function(){console.log("#saved_tribe_venue is loaded"),function(){const c=window.location.href;/post-new.php/.test(c)&&e("body").addClass("venuecheck-new");/post.php/.test(c)&&e("body").addClass("venuecheck-update");e(document).on("click","#venuecheck-conflicts-button, #venuecheck-conflicts-link, #venuecheck-report-conflicts-link, #venuecheck-modified",(function(){e("#venuecheck-conflicts-report-count, #venuecheck-conflicts-report-container").remove(),e("#venuecheck-report-container,#venuecheck-messages-container,#venuecheck-modified-publish,#venuecheck-modified,#venuecheck-conflicts-report").hide(),e("#venuecheck-messages-container").removeClass("has-messages"),e("#venuecheck-messages-container").addClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-wait").show(),function(){const c={};e.each(e("form#post").serializeArray(),(function(e,n){c[n.name]=n.value})),!0===e("#allDayCheckbox").prop("checked")&&(c.EventStartTime="00:00:00",c.EventEndTime="23:59:59");const s=c.EventStartTime;venuecheck.debug&&console.log("start",s);const o=c.EventEndTime,r=t(s),u=t(o),l=[],d={eventStart:c.EventStartDate+" "+r,eventEnd:c.EventEndDate+" "+u,eventTimezone:c.EventTimezone,eventOffsetStart:c._venuecheck_event_offset_start,eventOffsetEnd:c._venuecheck_event_offset_end};l.push(d);const v=e("form#post").serialize();if(e("#saved_tribe_venue").prop("readonly",!0).addClass("readonly").addClass("venuecheck-preserve-disabled"),e(".tribe-datetime-block :input:disabled").addClass("venuecheck-preserve-disabled"),e("#publish").prop("disabled",!0),e(".tribe-datetime-block :input").prop("disabled",!0),e("#tribe_events_event_details a").not("#venuecheck-cancel, #venuecheck-recurrence-warning-continue, #venuecheck-recurrence-warning-cancel, .select2-choice").addClass("venuecheck-disabled"),venuecheck.debug&&console.log("nonce: "+venuecheck.nonce),void 0!==c["is_recurring[]"])return venuecheck.debug&&console.log("RECURRING EVENT"),e.ajax({type:"POST",url:venuecheck.ajax_url,dataType:"json",data:{action:"venuecheck_get_event_recurrences",nonce:venuecheck.nonce,post_data:v}}).done((function(c){if(e.merge(l,c),venuecheck.debug&&(console.log("=====/////RECURRENCES-RECURRING/////====="),console.log(l),console.log("=====/////RECURRENCES-RECURRING/////=====")),l.length>50){i();const c=l.length;e("#venuecheck-messages-container").addClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-recurrence-warning").show(),e("#venuecheck-recurrence-count").text(c),e("#venuecheck-recurrence-warning-cancel").unbind().click((function(){return e("#venuecheck-messages-container, #venuecheck-recurrence-warning").hide(),a(),!1})),e("#venuecheck-recurrence-warning-continue").unbind().click((function(){e("#venuecheck-messages-container, #venuecheck-recurrence-warning").hide(),venuecheck.debug&&console.log("venuecheck_check_venues 1"),n(l,25)}))}else i(),venuecheck.debug&&console.log("venuecheck_check_venues 2"),n(l,25)})).fail((function(e,n,c){console.error("ajax error: "+c)}));venuecheck.debug&&(console.log("=====/////RECURRENCES/////====="),console.log(l),console.log("=====/////RECURRENCES/////=====")),i(),venuecheck.debug&&console.log("venuecheck_check_venues 3"),n(l,25)}()}));const o=e("#event_tribe_venue tbody").first(),u=o.find("tr.saved-linked-post > td").last();console.log("$venuecheckVenueSection",o),o.addClass("venuecheck-section"),o.children("tr").first().before('<tr><td colspan="2" class="venuecheck-section-label">Venue Check<i class="fas fa-spinner fa-pulse venuecheck-preload"></i></td></tr>'),u.wrapInner('<div id="venuecheck-venue-select"></div>'),u.append('<a id="venuecheck-conflicts-button" class="button">Find available venues</a>'),u.append('<div id="venuecheck-messages-container" style="display: none;"><div id="venuecheck-messages"></div></div>'),o.find("tr.linked-post.venue").first().after('<tr id="venuecheck-report-container" style="display: none;"><td colspan="2" id="venuecheck-report"></td></tr><tr class="venuecheck-spacer"><td></td><td></td></tr>'),e("#event_tribe_venue .edit-linked-post-link").after('<div id="venuecheck-change-venue" style="display: none;"><a id="venuecheck-conflicts-link" class="button">Change Venue</a></div>'),e("#saved_tribe_venue").on("change",(function(){r()})),e("body").hasClass("venuecheck-new")?e("#venuecheck-conflicts-button").show():e("#venuecheck-conflicts-button").hide();e("#major-publishing-actions").append('<div id="venuecheck-modified-publish" style="display: none;" class="notice notice-error">Because the date/time of this event was modified, the currently selected venue may not be available. See venue selection below for more information.</div>'),e("#venuecheck-messages").append(['<div id="venuecheck-wait" style="display: none;"><span class="venuecheck-message"><i class="fas fa-spinner fa-pulse fa-fw"></i><span class="sr-only">Loading...</span>Getting event recurrences...</span></div>','<div id="venuecheck-modified" style="display: none;" class="notice notice-error">Because the date/time of this event was modified, you need to <a id="modified-conflicts">recheck for venue conflicts</a> before you can save changes.</div>','<div id="venuecheck-progress" style="display: none;"><span class="venuecheck-message"><i class="fas fa-spinner fa-pulse fa-fw"></i><span class="sr-only">Loading...</span>Finding available venues...</span> <span class="venuecheck-message venuecheck-progress-percent-done">0%</span><div id="venuecheck-progress-bar" class="progress-bar green stripes"><span style="width: 0%"></span></div></div>','<div id="venuecheck-recurrence-warning" style="display: none;" class="notice notice-warning">It may take up to a minute or more to find available venues for all <span id="venuecheck-recurrence-count"></span> events in this series.<br><em>Note: this system is only able to check conflicts up to 2 years into the future.</em><br>Would you like to continue? <a id="venuecheck-recurrence-warning-continue">Continue</a><span class="venuecheck-divider">&nbsp;|&nbsp;</span><a id="venuecheck-recurrence-warning-cancel">Cancel</a></div>']),e("#venuecheck-report-container td").append('<div id="venuecheck-conflicts-report"></div>'),e("#saved_tribe_venue").prop("readonly",!0).prop("autocomplete","off").addClass("readonly"),e(".edit-linked-post-link").html(""),e("#venuecheck-change-venue").show(),s(),r()}()}),1e3,9e3),waitForElementToDisplay("#tribe_events_event_details",(function(){console.log("#tribe_events_event_details is loaded"),e("#tribe_events_event_details").addClass("venuecheck-update")}),1e3,9e3),e("#allDayCheckbox").click((function(){s()}))}));
jQuery((function(e){const n={progress:null,venueSelect:"#saved_tribe_venue",init(){window.addEventListener("load",c=>{venuecheck.debug&&console.log("load event fire",c);const s=window.location.href;/post-new.php/.test(s)&&e("body").addClass("venuecheck-new"),/post.php/.test(s)&&e("body").addClass("venuecheck-update"),setTimeout((function(){const c=e("form#post"),s=c.serialize();venuecheck.debug&&(console.log("check form change status after 3 seconds"),console.log("is origForm same as current state?",c.serialize()===s)),e(document).on("change","body.venuecheck-update #EventInfo :input,body.venuecheck-update #EventInfo .tribe-dropdown,body.venuecheck-update #EventInfo .tribe-button-field",(function(){c.serialize()!==s?n.venuecheck_show_modified_msg():n.venuecheck_hide_modified_msg()})),e(document).on("click","body.venuecheck-update .tribe-row-delete-dialog .ui-dialog-buttonpane .ui-dialog-buttonset .button-red",(function(){n.venuecheck_show_modified_msg()}))}),3e3)}),n.waitForElementToDisplay("#saved_tribe_venue",(function(){console.log("#saved_tribe_venue is loaded"),n.eventTribeVenueLoaded()}),1e3,9e3),n.waitForElementToDisplay("#tribe_events_event_details",(function(){console.log("#tribe_events_event_details is loaded"),n.tribeEventsEventDetailsLoaded()}),1e3,9e3),e("#allDayCheckbox").click((function(){n.venuecheck_show_hide_offsets()}))},tribeEventsEventDetailsLoaded(){e("#tribe_events_event_details").addClass("venuecheck-update")},eventTribeVenueLoaded(){console.log("eventTribeVenueLoaded");const c=window.location.href;/post-new.php/.test(c)&&e("body").addClass("venuecheck-new"),/post.php/.test(c)&&e("body").addClass("venuecheck-update"),e(document).on("click","#venuecheck-conflicts-button, #venuecheck-conflicts-link, #venuecheck-report-conflicts-link, #venuecheck-modified",(function(){n.venuecheck_find_available_venues()}));const s=e("#event_tribe_venue tbody").first(),t=s.find("tr.saved-linked-post > td").last();console.log("$venuecheckVenueSection",s),s.addClass("venuecheck-section"),s.children("tr").first().before('<tr><td colspan="2" class="venuecheck-section-label">Venue Check<i class="fas fa-spinner fa-pulse venuecheck-preload"></i></td></tr>'),t.wrapInner('<div id="venuecheck-venue-select"></div>'),t.append('<a id="venuecheck-conflicts-button" class="button">Find available venues</a>'),t.append('<div id="venuecheck-messages-container" style="display: none;"><div id="venuecheck-messages"></div></div>'),s.find("tr.linked-post.venue").first().after('<tr id="venuecheck-report-container" style="display: none;"><td colspan="2" id="venuecheck-report"></td></tr><tr class="venuecheck-spacer"><td></td><td></td></tr>'),e("#event_tribe_venue .edit-linked-post-link").after('<div id="venuecheck-change-venue" style="display: none;"><a id="venuecheck-conflicts-link" class="button">Change Venue</a></div>'),e("#saved_tribe_venue").on("change",(function(){n.venuecheck_show_hide_divider()})),e("body").hasClass("venuecheck-new")?e("#venuecheck-conflicts-button").show():e("#venuecheck-conflicts-button").hide();e("#major-publishing-actions").append('<div id="venuecheck-modified-publish" style="display: none;" class="notice notice-error">Because the date/time of this event was modified, the currently selected venue may not be available. See venue selection below for more information.</div>'),e("#venuecheck-messages").append(['<div id="venuecheck-wait" style="display: none;"><span class="venuecheck-message"><i class="fas fa-spinner fa-pulse fa-fw"></i><span class="sr-only">Loading...</span>Getting event recurrences...</span></div>','<div id="venuecheck-modified" style="display: none;" class="notice notice-error">Because the date/time of this event was modified, you need to <a id="modified-conflicts">recheck for venue conflicts</a> before you can save changes.</div>','<div id="venuecheck-progress" style="display: none;"><span class="venuecheck-message"><i class="fas fa-spinner fa-pulse fa-fw"></i><span class="sr-only">Loading...</span>Finding available venues...</span> <span class="venuecheck-message venuecheck-progress-percent-done">0%</span><div id="venuecheck-progress-bar" class="progress-bar green stripes"><span style="width: 0%"></span></div></div>','<div id="venuecheck-recurrence-warning" style="display: none;" class="notice notice-warning">It may take up to a minute or more to find available venues for all <span id="venuecheck-recurrence-count"></span> events in this series.<br><em>Note: this system is only able to check conflicts up to 2 years into the future.</em><br>Would you like to continue? <a id="venuecheck-recurrence-warning-continue">Continue</a><span class="venuecheck-divider">&nbsp;|&nbsp;</span><a id="venuecheck-recurrence-warning-cancel">Cancel</a></div>']),e("#venuecheck-report-container td").append('<div id="venuecheck-conflicts-report"></div>'),n.venuecheck_toggle_readonly(!0),e("#saved_tribe_venue").prop("autocomplete","off"),e(".edit-linked-post-link").html(""),e("#venuecheck-change-venue").show(),n.venuecheck_show_hide_offsets(),n.venuecheck_show_hide_divider()},venuecheck_get_event_recurrences(){const c={};e.each(e("form#post").serializeArray(),(function(e,n){c[n.name]=n.value})),!0===e("#allDayCheckbox").prop("checked")&&(c.EventStartTime="00:00:00",c.EventEndTime="23:59:59");const s=c.EventStartTime;venuecheck.debug&&console.log("start",s);const t=c.EventEndTime,o=n.venuecheck_convert_time(s),i=n.venuecheck_convert_time(t),a=[],u={eventStart:c.EventStartDate+" "+o,eventEnd:c.EventEndDate+" "+i,eventTimezone:c.EventTimezone,eventOffsetStart:c._venuecheck_event_offset_start,eventOffsetEnd:c._venuecheck_event_offset_end};a.push(u);const r=e("form#post").serialize();if(n.venuecheck_disable_form(),venuecheck.debug&&console.log("nonce: "+venuecheck.nonce),void 0!==c["is_recurring[]"])return venuecheck.debug&&console.log("RECURRING EVENT"),e.ajax({type:"POST",url:venuecheck.ajax_url,dataType:"json",data:{action:"venuecheck_get_event_recurrences",nonce:venuecheck.nonce,post_data:r}}).done((function(c){if(e.merge(a,c),venuecheck.debug&&(console.log("=====/////RECURRENCES-RECURRING/////====="),console.log(a),console.log("=====/////RECURRENCES-RECURRING/////=====")),a.length>50){n.venuecheck_hide_wait();const c=a.length;e("#venuecheck-messages-container").addClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-recurrence-warning").show(),e("#venuecheck-recurrence-count").text(c),e("#venuecheck-recurrence-warning-cancel").unbind().click((function(){return e("#venuecheck-messages-container, #venuecheck-recurrence-warning").hide(),n.venuecheck_enable_form(),!1})),e("#venuecheck-recurrence-warning-continue").unbind().click((function(){e("#venuecheck-messages-container, #venuecheck-recurrence-warning").hide(),venuecheck.debug&&console.log("venuecheck_check_venues 1"),n.venuecheck_check_venues(a,25)}))}else n.venuecheck_hide_wait(),venuecheck.debug&&console.log("venuecheck_check_venues 2"),n.venuecheck_check_venues(a,25)})).fail((function(e,n,c){console.error("ajax error: "+c)}));venuecheck.debug&&(console.log("=====/////RECURRENCES/////====="),console.log(a),console.log("=====/////RECURRENCES/////=====")),n.venuecheck_hide_wait(),venuecheck.debug&&console.log("venuecheck_check_venues 3"),n.venuecheck_check_venues(a,25)},venuecheck_check_venues(c,s){n.venuecheck_show_progress_bar();const t=e("#post_ID").val(),o=[];for(let e=0;e<c.length;e+=s)venuecheck.debug&&console.log("venuecheck_check_venues i: "+e),o.push(c.slice(e,e+s));let i=[];return o.reduce((function(a,u){const r=c.length,v=o.indexOf(u);return a.then((function(){return venuecheck.debug&&console.log("nonce: "+venuecheck.nonce),e.ajax({type:"POST",dataType:"json",url:venuecheck.ajax_url,data:{action:"venuecheck_check_venues",nonce:venuecheck.nonce,event_recurrences:u,postID:t,total_count:r,batch_size:s,batch_count:v},beforeSend(){const e=Math.max(0,(v+1)*s-r),c=Math.round(v*s/r*100),t=Math.round(((v+1)*s-e)/r*100);o.length>1&&n.venuecheck_check_venues_progress(c,t),n.venuecheck_toggle_readonly(!0)}}).then((function(e){venuecheck.debug&&console.log("venuecheck_check_venues ajax return data:",e),i=i.concat(e)}))}))}),Promise.resolve()).then((function(){const c=Object.values(i.reduce((function(e,n){return e[n.venueTitle]?e[n.venueTitle].events=e[n.venueTitle].events.concat(n.events):e[n.venueTitle]=n,e}),{}));venuecheck.debug&&console.log("CONFLICTS",i),i=c,window.venueConflicts=i,venuecheck.debug&&console.log("CONFLICTS MERGED",i),clearTimeout(n.progress),e("#venuecheck-progress .progress-bar span").css({width:"100%"}),e(".venuecheck-progress-percent-done").text("100%"),setTimeout((function(){n.venuecheck_check_venues_handler(i)}),500)}))},venuecheck_check_venues_progress(c,s){if(clearTimeout(n.progress),venuecheck.debug&&console.log("check_venues_progress percent: "+c),e("#venuecheck-progress .progress-bar span").css({width:c+"%"}),e(".venuecheck-progress-percent-done").text(c+"%"),(c+=Math.floor(5*Math.random()+1))<=s){const e=Math.floor(1500*Math.random()+300);n.progress=setTimeout((function(){n.venuecheck_check_venues_progress(c,s)}),e)}else 100===s&&(e("#venuecheck-progress .progress-bar span").css({width:"100%"}),e(".venuecheck-progress-percent-done").text("100%"))},venuecheck_check_venues_handler(c){e("body").addClass("venuecheck-update"),venuecheck.debug&&console.log("starting venuecheck_check_venues_handler");const s=e("#saved_tribe_venue").find("option, optgroup"),t=[{}];venuecheck.debug&&console.log("venuecheck_venues",s),s.each((function(){"My Venues"!==e(this).attr("label")&&"My Venues"!==e(this).parent().attr("label")||e(this).remove(),"Available Venues"===e(this).attr("label")&&(e(this).parent().append(e(this).html()),e(this).remove())}));let o="",i="";if(void 0!==c&&0!==c.length){let n=Object.keys(c).length;n+=1===n?" unavailable venue.":" unavailable venues.",o+='<div id="venuecheck-conflicts-report-count" class="notice notice-info">'+n,o+='&nbsp;<a id="venuecheck-conflicts-report-link">Show Details</a></div>',i+='<div id="venuecheck-conflicts-report-container">',i+='<div id="venuecheck-report-links">',i+='<a id="venuecheck-report-conflicts-link">Recheck for Venue Conflicts</a>',i+='<span class="venuecheck-divider">&nbsp;|&nbsp;</span>',i+='<a id="venuecheck-conflicts-report-close">Close</a>',i+="</div>",i+='<table id="venuecheck-conflicts-report-table">',venuecheck.debug&&console.log("venuecheck_conflicts",c,e.type(c)),venuecheck.debug&&console.log("venuecheck_venue_options",t),e("#saved_tribe_venue option").removeAttr("disabled");const s="#acf-"+window.venuecheck.additional_venue_settings.acf_field_key;e(s+" option").removeAttr("disabled"),e.each(c,(function(n,c){venuecheck.debug&&console.log(n,c.venueID,c),e('#saved_tribe_venue option[value="'+c.venueID+'"]').attr("disabled","disabled").removeAttr("selected"),i+='<thead class="venuecheck-conflicts-report-venue-title"><tr><td colspan="2">'+c.venueTitle+"</td></tr></thead>",i+='<thead class="venuecheck-conflicts-report-venue-heading"><tr><td>Date</td><td>Event</td></tr></thead><tbody>',e.each(c.events,(function(e,n){i+='<tr><td class="venuecheck-conflicts-report-venue-date">'+n.eventDate+'</td><td class="venuecheck-conflicts-report-venue-event"><a href="'+n.eventLink+'" target="_blank" class="venuecheck-report-link"><span>'+n.eventTitle+'</span><i class="fas fa-external-link-alt" aria-hidden="true"></i></a></td></tr>'}))})),e("#saved_tribe_venue").select2(),i+="</tbody></table></div>"}else 0===c.length&&(o+='<div id="venuecheck-conflicts-report-count" class="notice notice-info">All venues are available.</div>',i+="",e("#saved_tribe_venue option").removeAttr("disabled"),e("#saved_tribe_venue").select2());e("#venuecheck-messages").append(o),e("#venuecheck-conflicts-report").append(i).show(),e("#venuecheck-conflicts-report-link, #venuecheck-conflicts-report-close").on("click",(function(){e("#venuecheck-report-container").slideToggle("fast"),e("#venuecheck-conflicts-report-link").html("Show Details"===e("#venuecheck-conflicts-report-link").text()?"Hide Details":"Show Details")})),e("#venuecheck-venue-select").show(),e("#venuecheck-processing, #venuecheck-progress").hide(),e("#venuecheck-conflicts-link").removeClass("venuecheck-disabled"),e("#publish").prop("disabled",!1),n.venuecheck_toggle_readonly(!1),e("#venuecheck-change-venue").hide(),e("body").addClass("venuecheck-venues"),n.venuecheck_enable_form()},venuecheck_convert_time(e){if(!e)return"00:00:00";let n=0;const c=e.match(/^(\d+)/);c&&1 in c&&(n=Number(c[1]));let s=0;const t=e.match(/:(\d+)/);t&&1 in t&&(s=Number(t[1]));const o=e.substr(-2).toLowerCase();"pm"===o&&n<12&&(n+=12),"am"===o&&12===n&&(n-=12);let i=n.toString(),a=s.toString();return n<10&&(i="0"+i),s<10&&(a="0"+a),i+":"+a+":00"},venuecheck_show_hide_offsets(){!0===e("#allDayCheckbox").prop("checked")?(e("#venuecheck-offsets").hide(),e("#_venuecheck_event_offset_start").val("0"),e("#_venuecheck_event_offset_end").val("0")):e("#venuecheck-offsets").show()},venuecheck_show_modified_msg(){e("#venuecheck-messages-container, #venuecheck-modified-publish, #venuecheck-modified").show(),e("#venuecheck-report-container, #venuecheck-conflicts-report-count, #venuecheck-progress").hide(),e("#publish").prop("disabled",!0),n.venuecheck_toggle_readonly(!0),e("#venuecheck-change-venue").show()},venuecheck_hide_modified_msg(){e("#venuecheck-messages-container, #venuecheck-modified-publish, #venuecheck-modified").not(".active").hide(),e("#venuecheck-messages-container.has-messages, #venuecheck-conflicts-report-count").show(),e("#publish").prop("disabled",!1),e("body").hasClass("venuecheck-venues")&&(e("#venuecheck-messages-container").show(),e("#venuecheck-report-container").hide(),e("#venuecheck-conflicts-report-link").text("Show Details"),n.venuecheck_toggle_readonly(!1))},venuecheck_toggle_readonly(c){console.log("readonly"),console.log(n.venueSelect),c?e(n.venueSelect).prop("readonly",!0).addClass("readonly"):e(n.venueSelect).prop("readonly",!1).removeClass("readonly")},venuecheck_show_wait(){e("#venuecheck-messages-container").addClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-wait").show()},venuecheck_hide_wait(){e("#venuecheck-messages-container").removeClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-wait").hide()},venuecheck_hide_messages(){e("#venuecheck-conflicts-report-count, #venuecheck-conflicts-report-container").remove(),e("#venuecheck-report-container,#venuecheck-messages-container,#venuecheck-modified-publish,#venuecheck-modified,#venuecheck-conflicts-report").hide(),e("#venuecheck-messages-container").removeClass("has-messages")},venuecheck_disable_form(){e(n.venueSelect).prop("readonly",!0).addClass("readonly").addClass("venuecheck-preserve-disabled"),e(".tribe-datetime-block :input:disabled").addClass("venuecheck-preserve-disabled"),e("#publish").prop("disabled",!0),e(".tribe-datetime-block :input").prop("disabled",!0),e("#tribe_events_event_details a").not("#venuecheck-cancel, #venuecheck-recurrence-warning-continue, #venuecheck-recurrence-warning-cancel, .select2-choice").addClass("venuecheck-disabled")},venuecheck_enable_form(){e("#saved_tribe_venue:not(.venuecheck-preserve-disabled)").prop("readonly",!1).removeClass("readonly"),e(".tribe-datetime-block :input:not(.venuecheck-preserve-disabled)").prop("disabled",!1),e("#saved_tribe_venue, .tribe-datetime-block :input").removeClass("venuecheck-preserve-disabled"),e("#publish").prop("disabled",!1),e("#tribe_events_event_details a").removeClass("venuecheck-disabled")},venuecheck_show_progress_bar(){e("#venuecheck-progress .progress-bar span").css({width:"0%"}),e(".venuecheck-progress-percent-done").text("0%"),e("#venuecheck-messages-container, #venuecheck-progress").show()},venuecheck_find_available_venues(){n.venuecheck_hide_messages(),n.venuecheck_show_wait(),n.venuecheck_get_event_recurrences()},venuecheck_show_hide_divider(){""===e("#saved_tribe_venue").val()?e("#venuecheck-change-venue .venuecheck-divider").hide():e("#venuecheck-change-venue .venuecheck-divider").show()},waitForElementToDisplay(e,n,c,s){const t=Date.now();!function o(){null!==document.querySelector(e)?n():setTimeout((function(){s&&Date.now()-t>s||o()}),c)}()}};n.init()}));
jQuery((function(e){const c={progress:null,multiVenueEnabled:!1,venueSelectArray:["#saved_tribe_venue"],venueSelect:"#saved_tribe_venue",batchsize:venuecheck.batchsize,recurrence_warning_limit:venuecheck.recurrence_warning_limit,storedRecurrences:{origForm:null,recurrences:null},init(){c.multiVenueEnabled=!!venuecheck.multivenue&&venuecheck.multivenue,c.debugLog("In Multivenue mode? "+c.multiVenueEnabled),c.debugLog("venuecheck variables",venuecheck),c.multiVenueEnabled&&(venuecheck.use_tec_fields?(c.venueSelectArray=["#saved_tribe_venue","#venuecheck-additional-venues select"],c.venueSelect=c.venueSelectArray.join(", ")):(c.venueSelect="#acf-"+venuecheck.fieldkey,c.venueSelectArray=[c.venueSelect])),window.addEventListener("load",n=>{venuecheck.debug&&console.log("load event fire",n),setTimeout((function(){const n=e("form#post"),t=n.serialize();venuecheck.debug&&(console.log("check form change status after 3 seconds"),console.log("is origForm same as current state?",n.serialize()===t)),e(document).on("change","body.venuecheck-update #EventInfo :input,body.venuecheck-update #EventInfo .tribe-dropdown,body.venuecheck-update #EventInfo .tribe-button-field",(function(){n.serialize()!==t?c.venuecheck_show_modified_msg():c.venuecheck_hide_modified_msg()})),e(document).on("change",".recurrence-row input, .custom-recurrence-row input, .recurrence-row select, .custom-recurrence-row select",(function(){console.log("recurrence changed")})),e(document).on("click","body.venuecheck-update .tribe-row-delete-dialog .ui-dialog-buttonpane .ui-dialog-buttonset .button-red",(function(){c.venuecheck_show_modified_msg()}))}),3e3)}),c.waitForElementToDisplay(c.venueSelectArray[0],(function(){console.log(c.venueSelectArray[0]+" is loaded"),c.eventTribeVenueLoaded()}),1e3,9e3),c.waitForElementToDisplay("#tribe_events_event_details",(function(){console.log("#tribe_events_event_details is loaded"),c.tribeEventsEventDetailsLoaded()}),1e3,9e3),e("#allDayCheckbox").click((function(){c.venuecheck_show_hide_offsets()}))},tribeEventsEventDetailsLoaded(){e("#tribe_events_event_details").addClass("venuecheck-updated")},eventTribeVenueLoaded(){console.log("eventTribeVenueLoaded"),e(document).on("click","#venuecheck-conflicts-button, #venuecheck-conflicts-link, #venuecheck-report-conflicts-link, #venuecheck-modified",(function(){c.venuecheck_find_available_venues()}));const n=c.multiVenueEnabled?e(venuecheck.container_id+" tbody").first():e("#event_tribe_venue tbody").first(),t=n.find("tr.saved-linked-post > td").last();venuecheck.debug&&(console.log("$venuecheckVenueSection",n),console.log("$venueDropdown",t)),n.addClass("venuecheck-section"),n.children("tr").first().before('<tr><td colspan="2" class="venuecheck-section-label">Venue Check<i class="fas fa-spinner fa-pulse venuecheck-preload"></i></td></tr>'),t.wrapInner('<div id="venuecheck-venue-select"></div>'),t.append('<a id="venuecheck-conflicts-button" class="button">Find available venues</a>'),n.find(".edit-linked-post-link").after('<div id="venuecheck-change-venue" style="display: none;"><a id="venuecheck-conflicts-link" class="button">Change Venue</a></div>'),e("body").hasClass("venuecheck-new")?e("#venuecheck-conflicts-button").show():e("#venuecheck-conflicts-button").hide(),c.venuecheck_toggle_readonly(!0),e(c.venueSelect).prop("autocomplete","off"),e(".edit-linked-post-link").hide(),e("#venuecheck-change-venue").show(),c.venuecheck_show_hide_offsets(),c.venuecheck_show_hide_divider()},venuecheck_check_stored_recurrences(){if(console.log("checking storedRecurrences",c.storedRecurrences),c.storedRecurrences&&c.storedRecurrences.recurrences&&c.storedRecurrences.origForm===c.get_recurrence_form_data())c.venuecheck_disable_form(),c.venuecheck_hide_wait(),venuecheck.debug&&console.log("venuecheck_check_stored_recurrences have not changed"),c.venuecheck_check_venues(c.storedRecurrences.recurrences,c.batchsize);else{venuecheck.debug&&console.log("recurrences stored but recurrence changed?",c.storedRecurrences&&c.storedRecurrences.origForm&&c.storedRecurrences.origForm!==c.get_recurrence_form_data());const e=c.get_recurrence_form_data();console.log("recurrenceFormData",e),c.storedRecurrences.recurrences=null,c.storedRecurrences.origForm=e,console.log("storing Recurrences",c.storedRecurrences.origForm),c.venuecheck_get_event_recurrences()}},get_recurrence_form_data(){const c=e(".recurrence-row input, .custom-recurrence-row input, .recurrence-row select, .custom-recurrence-row select,.tribe-datetime-block input").serialize();return console.log("getting recurrence form",c),c},venuecheck_get_event_recurrences(){const n={};e.each(e("form#post").serializeArray(),(function(e,c){n[c.name]=c.value})),!0===e("#allDayCheckbox").prop("checked")&&(n.EventStartTime="00:00:00",n.EventEndTime="23:59:59");const t=n.EventStartTime;venuecheck.debug&&console.log("start",t);const s=n.EventEndTime,r=c.venuecheck_convert_time(t),o=c.venuecheck_convert_time(s),u=[],i={eventStart:n.EventStartDate+" "+r,eventEnd:n.EventEndDate+" "+o,eventTimezone:n.EventTimezone,eventOffsetStart:n._venuecheck_event_offset_start,eventOffsetEnd:n._venuecheck_event_offset_end};u.push(i);const a=e("form#post").serialize();if(c.venuecheck_disable_form(),venuecheck.debug&&console.log("nonce: "+venuecheck.nonce),void 0!==n["is_recurring[]"])return venuecheck.debug&&console.log("RECURRING EVENT"),e.ajax({type:"POST",url:venuecheck.ajax_url,dataType:"json",data:{action:"venuecheck_get_event_recurrences",nonce:venuecheck.nonce,post_data:a}}).done((function(n){if(e.merge(u,n),venuecheck.debug&&(console.log("=====/////RECURRENCES-RECURRING/////====="),console.log(u),console.log("=====/////RECURRENCES-RECURRING/////=====")),u.length>c.recurrence_warning_limit){c.venuecheck_hide_wait();const n=u.length;e("#venuecheck-messages-container").addClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-recurrence-warning").show(),e("#venuecheck-recurrence-count").text(n),e("#venuecheck-recurrence-warning-cancel").unbind().click((function(){return e("#venuecheck-messages-container, #venuecheck-recurrence-warning").hide(),c.venuecheck_enable_form(),!1})),e("#venuecheck-recurrence-warning-continue").unbind().click((function(){e("#venuecheck-messages-container, #venuecheck-recurrence-warning").hide(),venuecheck.debug&&console.log("venuecheck_check_venues 1"),c.venuecheck_check_venues(u,c.batchsize)}))}else c.venuecheck_hide_wait(),venuecheck.debug&&console.log("venuecheck_check_venues 2"),c.venuecheck_check_venues(u,c.batchsize)})).fail((function(e,c,n){console.error("ajax error: "+n)}));venuecheck.debug&&(console.log("=====/////RECURRENCES/////====="),console.log(u),console.log("=====/////RECURRENCES/////=====")),c.venuecheck_hide_wait(),venuecheck.debug&&console.log("venuecheck_check_venues 3"),c.venuecheck_check_venues(u,c.batchsize)},venuecheck_check_venues(n,t){c.venuecheck_show_progress_bar(),c.storedRecurrences.recurrences=n;const s=e("#post_ID").val(),r=[];for(let e=0;e<n.length;e+=t)venuecheck.debug&&console.log("venuecheck_check_venues i: "+e),r.push(n.slice(e,e+t));let o=[];return r.reduce((function(u,i){const a=n.length,l=r.indexOf(i);return u.then((function(){return venuecheck.debug&&console.log("nonce: "+venuecheck.nonce),e.ajax({type:"POST",dataType:"json",url:venuecheck.ajax_url,data:{action:"venuecheck_check_venues",nonce:venuecheck.nonce,event_recurrences:i,postID:s,total_count:a,batch_size:t,batch_count:l},beforeSend(){const e=Math.max(0,(l+1)*t-a),n=Math.round(l*t/a*100),s=Math.round(((l+1)*t-e)/a*100);r.length>1&&c.venuecheck_check_venues_progress(n,s),c.venuecheck_toggle_readonly(!0)}}).then((function(e){venuecheck.debug&&console.log("venuecheck_check_venues ajax return data:",e),o=o.concat(e)}))}))}),Promise.resolve()).then((function(){const n=Object.values(o.reduce((function(e,c){return e[c.venueTitle]?(e[c.venueTitle].events=e[c.venueTitle].events.concat(c.events),!e[c.venueTitle].series&&c.series?e[c.venueTitle].series=c.series:e[c.venueTitle].series&&c.series&&(e[c.venueTitle].series=Object.assign(e[c.venueTitle].series,c.series))):e[c.venueTitle]=c,e}),{}));venuecheck.debug&&console.log("CONFLICTS",o),o=n,window.venueConflicts=o,venuecheck.debug&&console.log("CONFLICTS MERGED",o),clearTimeout(c.progress),e("#venuecheck-progress .progress-bar span").css({width:"100%"}),e(".venuecheck-progress-percent-done").text("100%"),setTimeout((function(){c.venuecheck_check_venues_handler(o)}),500)}))},venuecheck_check_venues_progress(n,t){if(clearTimeout(c.progress),venuecheck.debug&&console.log("check_venues_progress percent: "+n),e("#venuecheck-progress .progress-bar span").css({width:n+"%"}),e(".venuecheck-progress-percent-done").text(n+"%"),(n+=Math.floor(5*Math.random()+1))<=t){const e=Math.floor(1500*Math.random()+300);c.progress=setTimeout((function(){c.venuecheck_check_venues_progress(n,t)}),e)}else 100===t&&(e("#venuecheck-progress .progress-bar span").css({width:"100%"}),e(".venuecheck-progress-percent-done").text("100%"))},venuecheck_check_venues_handler(n){e("body").addClass("venuecheck-update"),venuecheck.debug&&console.log("starting venuecheck_check_venues_handler");const t=e(c.venueSelect).find("option, optgroup"),s=[{}];venuecheck.debug&&console.log("venuecheck_venues",t),c.multiVenueEnabled||t.each((function(){"My Venues"!==e(this).attr("label")&&"My Venues"!==e(this).parent().attr("label")||e(this).remove(),"Available Venues"===e(this).attr("label")&&(e(this).parent().append(e(this).html()),e(this).remove())}));let r="",o="",u=null;if(void 0!==n&&0!==n.length){let t=Object.keys(n).length;t+=1===t?" unavailable venue.":" unavailable venues.",r+='<div id="venuecheck-conflicts-report-count" class="venuecheck-notice notice-info">'+t,r+='&nbsp;<a id="venuecheck-conflicts-report-link">Show Details</a></div>',o+='<div id="venuecheck-conflicts-report-container">',o+='<div id="venuecheck-report-links">',o+='<a id="venuecheck-report-conflicts-link">Recheck for Venue Conflicts</a>',o+='<span class="venuecheck-divider">&nbsp;|&nbsp;</span>',o+='<a id="venuecheck-conflicts-report-close">Close</a>',o+="</div>",o+='<table id="venuecheck-conflicts-report-table">',o+="</table></div>",u=e(o),venuecheck.debug&&console.log("venuecheck_conflicts",n,e.type(n)),venuecheck.debug&&console.log("venuecheck_venue_options",s),e(c.venueSelect+" option").removeAttr("disabled"),e.each(n,(function(n,t){venuecheck.debug&&console.log(n,t.venueID,t),e(c.venueSelect+' option[value="'+t.venueID+'"]').attr("disabled","disabled").removeAttr("selected");const s=e(c.generate_venue_report(t));if(this.series){const c=this.venueID;e.each(this.series,(function(){const e="series-"+c+"-"+this.id,n=s.find("."+e).first();n.addClass("first");const t=s.find("."+e+":not(.first)");t.length&&n.addClass("accordion"),n.attr("data-series",e),n.find(".venuecheck-conflicts-report-venue-date").prepend('<i class="fa-sync-alt fas" aria-hidden="true"></i>'),n.find(".venuecheck-conflicts-report-venue-event a").after('<span class="recurrence">'+this.recurrence+"</span>"),n.after(t),t.hide()}))}u.find("#venuecheck-conflicts-report-table").append(s)})),c.multiVenueEnabled||e("#saved_tribe_venue").select2()}else 0===n.length&&(r+='<div id="venuecheck-conflicts-report-count" class="venuecheck-notice notice-info">All venues are available.</div>',o+="",e(c.venueSelect+" option").removeAttr("disabled"),c.multiVenueEnabled||e("#saved_tribe_venue").select2());e("#venuecheck-messages").append(r),e("#venuecheck-conflicts-report").append(u).show(),e("#venuecheck-conflicts-report-link, #venuecheck-conflicts-report-close").on("click",(function(){e("#venuecheck-report-container").slideToggle("fast"),e("#venuecheck-conflicts-report-link").html("Show Details"===e("#venuecheck-conflicts-report-link").text()?"Hide Details":"Show Details")})),e("tr.accordion .venuecheck-conflicts-report-venue-date i.fa-sync-alt.fas").on("click",(function(){const c=e(this).parents("tr.recurring.first").attr("data-series");console.log("others","tr.recurring."+c+":not(.first)"),e(this).parents("#venuecheck-conflicts-report-table tbody").find("tr.recurring."+c+":not(.first)").toggle()})),e("#venuecheck-venue-select").show(),e("#venuecheck-processing, #venuecheck-progress").hide(),e("#venuecheck-conflicts-link").removeClass("venuecheck-disabled"),e("#publish").prop("disabled",!1),c.venuecheck_toggle_readonly(!1),e("#venuecheck-change-venue").hide(),e("body").addClass("venuecheck-venues"),c.venuecheck_enable_form()},generate_venue_report(c){const n=[];let t='<thead class="venuecheck-conflicts-report-venue-title"><tr><td colspan="2">'+c.venueTitle+"</td></tr></thead>";return t+='<thead class="venuecheck-conflicts-report-venue-heading"><tr><td>Date</td><td>Event</td></tr></thead><tbody>',e.each(c.events,(function(e,s){const r="event-"+c.venueID+"-"+s.eventID;if(!n.includes(s.eventID)){n.push(s.eventID);const e=s.eventID;s.eventParent?(s.eventClass="recurring",s.eventClass+=" series-"+c.venueID+"-"+s.eventParent):c.series&&c.series.eventID&&(s.eventClass="recurring",s.eventClass+=" series-"+c.venueID+"-"+e),t+='<tr id="'+r+'"class="'+s.eventClass+'"><td class="venuecheck-conflicts-report-venue-date">'+s.eventDate+'</td><td class="venuecheck-conflicts-report-venue-event"><a href="'+s.eventLink+'" target="_blank" class="venuecheck-report-link"><span class="name">'+s.eventTitle+'</span><i class="fas fa-external-link-alt" aria-hidden="true"></i></a></td></tr>'}})),t},venuecheck_convert_time(e){if(!e)return"00:00:00";let c=0;const n=e.match(/^(\d+)/);n&&1 in n&&(c=Number(n[1]));let t=0;const s=e.match(/:(\d+)/);s&&1 in s&&(t=Number(s[1]));const r=e.substr(-2).toLowerCase();"pm"===r&&c<12&&(c+=12),"am"===r&&12===c&&(c-=12);let o=c.toString(),u=t.toString();return c<10&&(o="0"+o),t<10&&(u="0"+u),o+":"+u+":00"},venuecheck_show_hide_offsets(){!0===e("#allDayCheckbox").prop("checked")?(e("#venuecheck-offsets").hide(),e("#_venuecheck_event_offset_start").val("0"),e("#_venuecheck_event_offset_end").val("0")):e("#venuecheck-offsets").show()},venuecheck_show_modified_msg(){e("#venuecheck-messages-container, #venuecheck-modified-publish, #venuecheck-modified").show(),e("#venuecheck-report-container, #venuecheck-conflicts-report-count, #venuecheck-progress").hide(),e("#publish").prop("disabled",!0),c.venuecheck_toggle_readonly(!0),e("#venuecheck-change-venue").show()},venuecheck_hide_modified_msg(){e("#venuecheck-messages-container, #venuecheck-modified-publish, #venuecheck-modified").not(".active").hide(),e("#venuecheck-messages-container.has-messages, #venuecheck-conflicts-report-count").show(),e("#publish").prop("disabled",!1),e("body").hasClass("venuecheck-venues")&&(e("#venuecheck-messages-container").show(),e("#venuecheck-report-container").hide(),e("#venuecheck-conflicts-report-link").text("Show Details"),c.venuecheck_toggle_readonly(!1))},venuecheck_toggle_readonly(n){console.log("readonly"),n?e(c.venueSelect).prop("readonly",!0).addClass("readonly"):e(c.venueSelect).prop("readonly",!1).removeClass("readonly")},venuecheck_show_wait(){e("#venuecheck-messages-container").addClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-wait").show()},venuecheck_hide_wait(){e("#venuecheck-messages-container").removeClass("has-messages"),e("#venuecheck-messages-container, #venuecheck-wait").hide()},venuecheck_hide_messages(){e("#venuecheck-conflicts-report-count, #venuecheck-conflicts-report-container").remove(),e("#venuecheck-report-container,#venuecheck-messages-container,#venuecheck-modified-publish,#venuecheck-modified,#venuecheck-conflicts-report").hide(),e("#venuecheck-messages-container").removeClass("has-messages")},venuecheck_disable_form(){e(c.venueSelect).prop("readonly",!0).addClass("readonly").addClass("venuecheck-preserve-disabled"),e(".tribe-datetime-block :input:disabled").addClass("venuecheck-preserve-disabled"),e("#publish").prop("disabled",!0),e(".tribe-datetime-block :input").prop("disabled",!0),e("#tribe_events_event_details a").not("#venuecheck-cancel, #venuecheck-recurrence-warning-continue, #venuecheck-recurrence-warning-cancel, .select2-choice").addClass("venuecheck-disabled")},venuecheck_enable_form(){for(const n of c.venueSelectArray)console.log(n+":not(.venuecheck-preserve-disabled)"),e(n+":not(.venuecheck-preserve-disabled)").prop("readonly",!1).removeClass("readonly");e(".tribe-datetime-block :input:not(.venuecheck-preserve-disabled)").prop("disabled",!1),e(c.venueSelect).removeClass("venuecheck-preserve-disabled"),e(".tribe-datetime-block :input").removeClass("venuecheck-preserve-disabled"),e("#publish").prop("disabled",!1),e("#tribe_events_event_details a").removeClass("venuecheck-disabled")},venuecheck_show_progress_bar(){e("#venuecheck-progress .progress-bar span").css({width:"0%"}),e(".venuecheck-progress-percent-done").text("0%"),e("#venuecheck-messages-container, #venuecheck-progress").show()},venuecheck_find_available_venues(){c.venuecheck_hide_messages(),c.venuecheck_show_wait(),c.venuecheck_check_stored_recurrences()},venuecheck_show_hide_divider(){""===e("#saved_tribe_venue").val()?e("#venuecheck-change-venue .venuecheck-divider").hide():e("#venuecheck-change-venue .venuecheck-divider").show()},debugLog(e,c=""){venuecheck.debug&&console.log(e,c)},waitForElementToDisplay(e,c,n,t){const s=Date.now();!function r(){null!==document.querySelector(e)?c():setTimeout((function(){t&&Date.now()-s>t||r()}),n)}()}};c.init()}));